<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>БРИГАДА: ULTIMATE TERMINAL v2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --explosive-orange: #ff8a00;
            --neon-cyan: #00f0ff;
            --hp-green: #39ff14;
            --bg-dark: #0a0a0a;
            --crt-line: rgba(18, 16, 16, 0.1);
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            text-transform: uppercase;
            overflow-x: hidden;
        }

        /* CRT ЭФФЕКТ СЕТКИ */
        body::before {
            content: " ";
            display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(var(--crt-line) 50%, rgba(0, 0, 0, 0) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            z-index: 100; background-size: 100% 4px, 3px 100%;
            pointer-events: none;
        }

        /* МЕРЦАНИЕ МОНИТОРА */
        @keyframes flicker {
            0% { opacity: 0.97; } 5% { opacity: 0.95; } 10% { opacity: 0.9; } 15% { opacity: 0.98; } 100% { opacity: 1; }
        }
        .flicker { animation: flicker 0.15s infinite; }

        .player-card {
            border: 4px solid white;
            box-shadow: 8px 8px 0px var(--explosive-orange);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px; width: 100%; max-width: 340px; box-sizing: border-box;
            position: relative; z-index: 10;
        }

        /* ТРЯСКА ПРИ БАСАХ */
        @keyframes shake {
            0% { transform: translate(0,0); }
            25% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(0,0); }
        }
        .bass-shake { animation: shake 0.1s infinite; }

        .album-art {
            width: 100%; height: 250px;
            border: 4px solid var(--neon-cyan);
            margin-bottom: 20px;
            background-color: #000; background-size: contain; background-position: center;
            background-repeat: no-repeat;
            display: flex; align-items: flex-end; position: relative;
            overflow: hidden;
        }

        /* ВИЗУАЛИЗАТОР */
        .visualizer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 40px; display: flex; align-items: flex-end;
            gap: 2px; padding: 0 5px; box-sizing: border-box;
            background: rgba(0,0,0,0.4);
        }
        .v-bar { flex: 1; background: var(--hp-green); height: 2px; transition: height 0.1s; }

        .track-info h2 { font-size: 10px; color: var(--neon-cyan); margin: 10px 0; line-height: 1.4; height: 30px; overflow: hidden;}
        .track-info p { font-size: 7px; color: var(--explosive-orange); margin-bottom: 20px; }
        
        /* СЧЕТЧИК */
        .stats { font-size: 6px; color: #555; margin-bottom: 10px; text-align: right; }

        .progress-container {
            width: 100%; height: 16px; background: #222; border: 2px solid white;
            margin-bottom: 20px; cursor: pointer; position: relative;
        }
        .progress-bar { width: 0%; height: 100%; background: var(--hp-green); pointer-events: none; box-shadow: 0 0 10px var(--hp-green); }
        
        .controls { display: flex; justify-content: space-between; gap: 10px; }
        .btn {
            background: white; border: none; padding: 10px; font-family: 'Press Start 2P', cursive;
            cursor: pointer; font-size: 9px; flex: 1; box-shadow: 4px 4px 0px #555; outline: none;
        }
        .btn:active { box-shadow: 0px 0px 0px; transform: translate(2px, 2px); }
        .btn-play { background: var(--explosive-orange); color: white; flex: 2; }
        
        .playlist { width: 100%; max-width: 340px; margin-top: 25px; }
        .playlist-item {
            font-size: 7px; padding: 12px; border: 2px solid #333; margin-bottom: 8px;
            background: #111; cursor: pointer; position: relative;
        }
        .playlist-item.active { border-color: var(--hp-green); color: var(--hp-green); }
    </style>
</head>
<body class="flicker">

    <div style="font-size: 8px; margin-bottom: 20px; text-shadow: 2px 2px red;">BRIGADA_ULTIMATE_v2.0</div>

    <div class="player-card" id="main-card">
        <div class="album-art" id="art">
            <div class="visualizer" id="visualizer">
                <!-- Бары добавятся через JS -->
            </div>
        </div>
        
        <div class="stats" id="play-count">PLAYS: 0</div>
        
        <div class="track-info">
            <h2 id="title">SYSTEM_INIT...</h2>
            <p id="artist">WAITING_FOR_DB</p>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>

        <div class="controls">
            <button class="btn" id="prev"><</button>
            <button class="btn btn-play" id="play">START</button>
            <button class="btn" id="next">></button>
        </div>
    </div>

    <div class="playlist" id="playlist-container"></div>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        const SUPABASE_URL = "https://lrggqgwzalqstwjbgbbn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_gNPjEKC-lYCueII_lnL-HA_gCKV_BFE";
        // --------------------

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const audio = new Audio();
        audio.crossOrigin = "anonymous"; 
        
        let currentTrackIndex = 0;
        let isPlaying = false;
        let tracks = [];
        const defaultImg = "poster.jpg";

        const playBtn = document.getElementById('play');
        const title = document.getElementById('title');
        const artist = document.getElementById('artist');
        const art = document.getElementById('art');
        const progress = document.getElementById('progress');
        const mainCard = document.getElementById('main-card');
        const playlistContainer = document.getElementById('playlist-container');

        // СОЗДАЕМ ВИЗУАЛИЗАТОР
        const viz = document.getElementById('visualizer');
        for(let i=0; i<20; i++) {
            let bar = document.createElement('div');
            bar.className = 'v-bar';
            viz.appendChild(bar);
        }

        async function fetchTracks() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*&order=id.asc`, {
                    headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
                });
                tracks = await response.json();
                if (tracks.length > 0) { renderPlaylist(); loadTrack(0); }
            } catch (e) { title.innerText = "CONN_ERROR"; }
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            tracks.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `[0${index+1}] ${track.title}`;
                item.onclick = () => { 
                    currentTrackIndex = index; 
                    loadTrack(index); 
                    playAudio(); 
                    tg.HapticFeedback.impactOccurred('medium');
                };
                playlistContainer.appendChild(item);
            });
        }

        async function updatePlayCount(track) {
            const newCount = (track.plays || 0) + 1;
            document.getElementById('play-count').innerText = `PLAYS: ${newCount}`;
            // Отправляем в базу
            fetch(`${SUPABASE_URL}/rest/v1/tracks?id=eq.${track.id}`, {
                method: 'PATCH',
                headers: { 
                    "apikey": SUPABASE_KEY, 
                    "Authorization": `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json",
                    "Prefer": "return=minimal"
                },
                body: JSON.stringify({ plays: newCount })
            });
        }

        function loadTrack(index) {
            const track = tracks[index];
            title.innerText = track.title;
            artist.innerText = track.artist;
            audio.src = track.audio_url;
            document.getElementById('play-count').innerText = `PLAYS: ${track.plays || 0}`;
            
            art.style.backgroundImage = `url('${defaultImg}')`;

            if (track.image_url && track.image_url !== "NULL" && track.image_url.trim() !== "") {
                art.style.backgroundImage = `url('${track.image_url}')`;
            } else {
                new jsmediatags.Reader(track.audio_url).read({
                    onSuccess: function(tag) {
                        const image = tag.tags.picture;
                        if (image) {
                            let base64String = "";
                            for (let i = 0; i < image.data.length; i++) base64String += String.fromCharCode(image.data[i]);
                            art.style.backgroundImage = `url('data:${image.format};base64,${window.btoa(base64String)}')`;
                        }
                    }
                });
            }
            document.querySelectorAll('.playlist-item').forEach((item, i) => item.classList.toggle('active', i === index));
        }

        function playAudio() {
            audio.play();
            isPlaying = true;
            playBtn.innerText = 'STOP';
            updatePlayCount(tracks[currentTrackIndex]);
            mainCard.classList.add('bass-shake');
        }

        playBtn.onclick = () => {
            tg.HapticFeedback.impactOccurred('light');
            if (isPlaying) { 
                audio.pause(); 
                playBtn.innerText = 'START'; 
                mainCard.classList.remove('bass-shake');
            } else { 
                playAudio(); 
            }
            isPlaying = !isPlaying;
        };

        // АНИМАЦИЯ ВИЗУАЛИЗАТОРА
        setInterval(() => {
            if (isPlaying) {
                document.querySelectorAll('.v-bar').forEach(bar => {
                    let h = Math.random() * 40;
                    bar.style.height = h + 'px';
                });
            } else {
                document.querySelectorAll('.v-bar').forEach(bar => bar.style.height = '2px');
            }
        }, 100);

        audio.ontimeupdate = () => {
            if (audio.duration) progress.style.width = (audio.currentTime / audio.duration) * 100 + '%';
        };

        audio.onended = () => document.getElementById('next').onclick();

        document.getElementById('next').onclick = () => {
            tg.HapticFeedback.selectionChanged();
            currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            loadTrack(currentTrackIndex);
            if(isPlaying) audio.play();
        };

        document.getElementById('prev').onclick = () => {
            tg.HapticFeedback.selectionChanged();
            currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            loadTrack(currentTrackIndex);
            if(isPlaying) audio.play();
        };

        document.getElementById('progress-container').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
            tg.HapticFeedback.impactOccurred('small');
        };

        fetchTracks();
    </script>
</body>
</html>