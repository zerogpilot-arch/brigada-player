<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>БРИГАДА: CLOUD TERMINAL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --explosive-orange: #ff8a00;
            --neon-cyan: #00f0ff;
            --hp-green: #39ff14;
            --bg-dark: #0a0a0a;
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle, #1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-transform: uppercase;
        }

        .player-card {
            border: 4px solid white;
            box-shadow: 8px 8px 0px var(--explosive-orange);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            width: 100%;
            max-width: 340px;
            box-sizing: border-box;
        }

        .album-art {
            width: 100%;
            height: 250px;
            border: 4px solid var(--neon-cyan);
            margin-bottom: 20px;
            background-color: #000;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            position: relative;
        }

        .track-info h2 { font-size: 10px; color: var(--neon-cyan); margin: 10px 0; line-height: 1.4; height: 30px; }
        .track-info p { font-size: 7px; color: var(--explosive-orange); margin-bottom: 20px; }

        .progress-container {
            width: 100%;
            height: 14px;
            background: #222;
            border: 2px solid white;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: var(--hp-green);
            box-shadow: 0 0 10px var(--hp-green);
        }

        .controls { display: flex; justify-content: space-between; gap: 10px; }

        .btn {
            background: white;
            border: none;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            font-size: 9px;
            flex: 1;
            box-shadow: 4px 4px 0px #555;
        }

        .btn-play { background: var(--explosive-orange); color: white; flex: 2; }

        .playlist { width: 100%; max-width: 340px; margin-top: 25px; }

        .playlist-item {
            font-size: 7px;
            padding: 12px;
            border: 2px solid #333;
            margin-bottom: 8px;
            background: #111;
            cursor: pointer;
        }

        .playlist-item.active { border-color: var(--hp-green); color: var(--hp-green); }
    </style>
</head>
<body>

    <div style="font-size: 10px; margin-bottom: 20px; text-shadow: 2px 2px red;">CLOUD_MODE: ACTIVE</div>

    <div class="player-card">
        <div class="album-art" id="art"></div>
        <div class="track-info">
            <h2 id="title">CONNECTING...</h2>
            <p id="artist">SUPABASE_DB</p>
        </div>
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>
        <div class="controls">
            <button class="btn" id="prev"><</button>
            <button class="btn btn-play" id="play">START</button>
            <button class="btn" id="next">></button>
        </div>
    </div>

    <div class="playlist" id="playlist-container"></div>

    <script>
        // --- КОНФИГУРАЦИЯ SUPABASE ---
        const SUPABASE_URL = "https://lrggqgwzalqstwjbgbbn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_gNPjEKC-lYCueII_lnL-HA_gCKV_BFE";
        // -----------------------------

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const audio = new Audio();
        let currentTrackIndex = 0;
        let isPlaying = false;
        let tracks = [];
        const defaultImg = "poster.jpg";

        const playBtn = document.getElementById('play');
        const title = document.getElementById('title');
        const artist = document.getElementById('artist');
        const art = document.getElementById('art');
        const progress = document.getElementById('progress');
        const playlistContainer = document.getElementById('playlist-container');

        // ЗАГРУЗКА ДАННЫХ ИЗ ОБЛАКА
        async function fetchTracks() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*`, {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                });
                tracks = await response.json();
                if (tracks.length > 0) {
                    renderPlaylist();
                    loadTrack(0);
                } else {
                    title.innerText = "DB_IS_EMPTY";
                }
            } catch (e) {
                title.innerText = "CONN_ERROR";
                console.error(e);
            }
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            tracks.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `[0${index+1}] ${track.title}`;
                item.onclick = () => { currentTrackIndex = index; loadTrack(index); audio.play(); isPlaying = true; playBtn.innerText = 'STOP'; };
                playlistContainer.appendChild(item);
            });
        }

        function loadTrack(index) {
            const track = tracks[index];
            title.innerText = track.title;
            artist.innerText = track.artist;
            audio.src = track.audio_url;
            const img = (track.image_url && track.image_url !== "NULL") ? track.image_url : defaultImg;
            art.style.backgroundImage = `url('${img}')`;
            
            document.querySelectorAll('.playlist-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        playBtn.onclick = () => {
            if (isPlaying) { audio.pause(); playBtn.innerText = 'START'; }
            else { audio.play(); playBtn.innerText = 'STOP'; }
            isPlaying = !isPlaying;
        };

        audio.ontimeupdate = () => {
            if (audio.duration) progress.style.width = (audio.currentTime / audio.duration) * 100 + '%';
        };

        document.getElementById('next').onclick = () => { currentTrackIndex = (currentTrackIndex + 1) % tracks.length; loadTrack(currentTrackIndex); if(isPlaying) audio.play(); };
        document.getElementById('prev').onclick = () => { currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length; loadTrack(currentTrackIndex); if(isPlaying) audio.play(); };

        fetchTracks();
    </script>
</body>
</html>