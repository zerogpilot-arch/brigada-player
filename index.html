<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>БРИГАДА: CLOUD TERMINAL v2.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --explosive-orange: #ff8a00;
            --neon-cyan: #00f0ff;
            --hp-green: #39ff14;
            --bg-dark: #0a0a0a;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            text-transform: uppercase;
        }

        /* МЕРЦАНИЕ ТОЛЬКО ДЛЯ ОБЛОЖКИ */
        @keyframes artFlicker {
            0% { opacity: 0.98; } 5% { opacity: 0.95; } 10% { opacity: 0.99; } 50% { opacity: 1; } 100% { opacity: 0.98; }
        }

        .player-card {
            border: 4px solid white;
            box-shadow: 8px 8px 0px var(--explosive-orange);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px; width: 100%; max-width: 340px; box-sizing: border-box;
        }

        .album-art {
            width: 100%; height: 250px;
            border: 4px solid var(--neon-cyan);
            margin-bottom: 20px;
            background-color: #000; background-size: contain; background-position: center;
            background-repeat: no-repeat;
            position: relative; overflow: hidden;
            animation: artFlicker 0.2s infinite;
        }

        .track-info h2 { font-size: 10px; color: var(--neon-cyan); margin: 10px 0; line-height: 1.4; height: 30px; }
        .track-info p { font-size: 7px; color: var(--explosive-orange); margin-bottom: 20px; }
        
        .stats { font-size: 6px; color: #555; text-align: right; margin-bottom: 5px; }

        .progress-container {
            width: 100%; height: 16px; background: #222; border: 2px solid white;
            margin-bottom: 20px; cursor: pointer; position: relative;
        }
        .progress-bar { width: 0%; height: 100%; background: var(--hp-green); pointer-events: none; }
        
        .controls { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
        .btn {
            background: white; border: none; padding: 10px; font-family: 'Press Start 2P', cursive;
            cursor: pointer; font-size: 9px; flex: 1; box-shadow: 4px 4px 0px #555;
        }
        .btn:active { box-shadow: 0px 0px 0px; transform: translate(2px, 2px); }
        .btn-play { background: var(--explosive-orange); color: white; flex: 2; }
        .btn-shuffle { background: #333; color: white; font-size: 7px; }
        .btn-shuffle.active { background: var(--neon-cyan); color: black; }

        /* ПОИСК */
        .search-box {
            width: 100%; max-width: 340px; margin-top: 20px;
            background: #111; border: 2px solid #333;
            padding: 10px; font-family: 'Press Start 2P', cursive;
            color: var(--neon-cyan); font-size: 8px; outline: none;
            box-sizing: border-box;
        }

        .playlist { width: 100%; max-width: 340px; margin-top: 15px; }
        .playlist-item {
            font-size: 7px; padding: 12px; border: 2px solid #333; margin-bottom: 8px;
            background: #111; cursor: pointer;
        }
        .playlist-item.active { border-color: var(--hp-green); color: var(--hp-green); }
    </style>
</head>
<body>

    <div style="font-size: 8px; margin-bottom: 20px; text-shadow: 2px 2px red;">BRIGADA_CLOUD_v2.1</div>

    <div class="player-card">
        <div class="album-art" id="art"></div>
        <div class="stats" id="play-count">PLAYS: 0</div>
        
        <div class="track-info">
            <h2 id="title">TERMINAL_READY</h2>
            <p id="artist">SELECT_TRACK</p>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>

        <div class="controls">
            <button class="btn" id="prev"><</button>
            <button class="btn btn-play" id="play">START</button>
            <button class="btn" id="next">></button>
        </div>
        <button class="btn btn-shuffle" id="shuffle">SHUFFLE: OFF</button>
    </div>

    <input type="text" class="search-box" id="search" placeholder="SEARCH_TRACK...">

    <div class="playlist" id="playlist-container"></div>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        const SUPABASE_URL = "https://lrggqgwzalqstwjbgbbn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_gNPjEKC-lYCueII_lnL-HA_gCKV_BFE";
        // --------------------

        const tg = window.Telegram.WebApp;
        tg.expand();

        const audio = new Audio();
        audio.crossOrigin = "anonymous"; 
        
        let tracks = [];
        let filteredTracks = [];
        let currentTrackIndex = 0;
        let isShuffle = false;
        const defaultImg = "poster.jpg";

        const playBtn = document.getElementById('play');
        const shuffleBtn = document.getElementById('shuffle');
        const title = document.getElementById('title');
        const artist = document.getElementById('artist');
        const art = document.getElementById('art');
        const progress = document.getElementById('progress');
        const playlistContainer = document.getElementById('playlist-container');
        const searchInput = document.getElementById('search');

        async function fetchTracks() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*&order=id.asc`, {
                    headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
                });
                tracks = await response.json();
                filteredTracks = tracks;
                if (tracks.length > 0) { renderPlaylist(); loadTrack(0); }
            } catch (e) { title.innerText = "CONN_ERROR"; }
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            filteredTracks.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                // Находим оригинальный индекс в основном массиве
                const realIndex = tracks.findIndex(t => t.id === track.id);
                item.innerHTML = `[0${realIndex+1}] ${track.title}`;
                item.onclick = () => { 
                    currentTrackIndex = realIndex;
                    loadTrack(realIndex); 
                    playAudio();
                };
                playlistContainer.appendChild(item);
            });
        }

        // Поиск
        searchInput.oninput = (e) => {
            const val = e.target.value.toLowerCase();
            filteredTracks = tracks.filter(t => 
                t.title.toLowerCase().includes(val) || t.artist.toLowerCase().includes(val)
            );
            renderPlaylist();
        };

        // Перемешивание
        shuffleBtn.onclick = () => {
            isShuffle = !isShuffle;
            shuffleBtn.innerText = isShuffle ? "SHUFFLE: ON" : "SHUFFLE: OFF";
            shuffleBtn.classList.toggle('active', isShuffle);
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        };

        function loadTrack(index) {
            const track = tracks[index];
            if (!track) return;
            title.innerText = track.title;
            artist.innerText = track.artist;
            audio.src = track.audio_url;
            document.getElementById('play-count').innerText = `PLAYS: ${track.plays || 0}`;
            
            art.style.backgroundImage = `url('${defaultImg}')`;

            if (track.image_url && track.image_url !== "NULL" && track.image_url.trim() !== "") {
                art.style.backgroundImage = `url('${track.image_url}')`;
            } else {
                new jsmediatags.Reader(track.audio_url).read({
                    onSuccess: function(tag) {
                        const image = tag.tags.picture;
                        if (image) {
                            let base64String = "";
                            for (let i = 0; i < image.data.length; i++) base64String += String.fromCharCode(image.data[i]);
                            art.style.backgroundImage = `url('data:${image.format};base64,${window.btoa(base64String)}')`;
                        }
                    }
                });
            }
            updateActiveItem();
        }

        function updateActiveItem() {
            document.querySelectorAll('.playlist-item').forEach((item) => {
                const trackTitle = tracks[currentTrackIndex].title;
                item.classList.toggle('active', item.innerText.includes(trackTitle));
            });
        }

        async function updatePlayCount(track) {
            const newCount = (track.plays || 0) + 1;
            fetch(`${SUPABASE_URL}/rest/v1/tracks?id=eq.${track.id}`, {
                method: 'PATCH',
                headers: { 
                    "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ plays: newCount })
            });
        }

        function playAudio() {
            audio.play();
            playBtn.innerText = 'STOP';
            updatePlayCount(tracks[currentTrackIndex]);
        }

        function stopAudio() {
            audio.pause();
            playBtn.innerText = 'START';
        }

        playBtn.onclick = () => {
            if (audio.paused) playAudio(); else stopAudio();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        };

        audio.ontimeupdate = () => {
            if (audio.duration) progress.style.width = (audio.currentTime / audio.duration) * 100 + '%';
        };

        // Логика переключения
        function nextTrack() {
            if (isShuffle) {
                currentTrackIndex = Math.floor(Math.random() * tracks.length);
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
            }
            loadTrack(currentTrackIndex);
            playAudio();
        }

        audio.onended = nextTrack;
        document.getElementById('next').onclick = nextTrack;
        
        document.getElementById('prev').onclick = () => {
            currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            loadTrack(currentTrackIndex);
            playAudio();
        };

        document.getElementById('progress-container').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
        };

        fetchTracks();
    </script>
</body>
</html>